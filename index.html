<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥ä»»åŠ¡è¿›åº¦åº“</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f7f7f5;
            --sidebar: #fbfbfa;
            --border: #e6e6e6;
            --text: #1f2328;
            --muted: #6b7280;
            --primary: #2563eb;
            --primary-soft: rgba(37, 99, 235, 0.08);
            --accent: #0891b2;
            --card: #ffffff;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Inter', 'Noto Sans SC', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .app-shell {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
        }

        aside {
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            padding: 24px 18px 32px;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .workspace {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .workspace-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(140deg, #2563eb, #38bdf8);
            display: grid;
            place-items: center;
            font-weight: 600;
            color: #fff;
            letter-spacing: 1px;
        }

        .workspace-info {
            display: grid;
            gap: 2px;
        }

        .workspace-info strong {
            font-size: 1rem;
        }

        .workspace-info span {
            font-size: 0.78rem;
            color: var(--muted);
        }

        .nav-group {
            display: grid;
            gap: 6px;
        }

        .nav-group h3 {
            margin: 0 0 8px;
            font-size: 0.78rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            color: var(--muted);
            font-size: 0.92rem;
            border: none;
            background: none;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .nav-button.active,
        .nav-button:hover {
            background: rgba(15, 23, 42, 0.04);
            color: var(--text);
        }

        .nav-icon {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            background: rgba(15, 23, 42, 0.05);
            display: grid;
            place-items: center;
            font-size: 0.75rem;
        }

        main {
            padding: 32px 48px 48px;
            display: grid;
            grid-template-rows: auto auto auto 1fr;
            gap: 24px;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.92rem;
            color: var(--muted);
        }

        .breadcrumbs strong {
            color: var(--text);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #1f2937;
        }

        .page-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 24px;
        }

        .page-title {
            display: grid;
            gap: 8px;
        }

        .page-title h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .page-title p {
            margin: 0;
            color: var(--muted);
            font-size: 0.95rem;
        }

        .metric-card {
            min-width: 220px;
            padding: 18px 20px;
            border-radius: 14px;
            border: 1px solid rgba(15, 23, 42, 0.06);
            background: var(--card);
            display: grid;
            gap: 10px;
        }

        .metric-card span {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .metric-card strong {
            font-size: 1.6rem;
            line-height: 1.2;
        }

        .toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar button,
        .toolbar input,
        .toolbar select {
            font: inherit;
        }

        .primary-btn {
            background: #1f2937;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .primary-btn:hover {
            background: #111827;
            transform: translateY(-1px);
        }

        .filter-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 12px 16px;
            border: 1px solid rgba(15, 23, 42, 0.06);
            backdrop-filter: blur(8px);
        }

        .filter-bar label {
            font-size: 0.82rem;
            color: var(--muted);
        }

        .filter-bar input[type="date"],
        .filter-bar input[type="search"] {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            background: #fff;
            width: 170px;
        }

        .filter-bar input[type="search"] {
            flex: 1;
        }

        .data-card {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            box-shadow: 0 18px 50px -40px rgba(15, 23, 42, 0.6);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #9ca3af;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(15, 23, 42, 0.06);
            background: rgba(249, 250, 251, 0.9);
        }

        tbody td {
            padding: 16px 18px;
            border-bottom: 1px solid rgba(15, 23, 42, 0.04);
            font-size: 0.94rem;
        }

        tbody tr:hover {
            background: rgba(15, 23, 42, 0.03);
        }

        .product-cell {
            display: grid;
            gap: 6px;
        }

        .product-title {
            font-weight: 600;
        }

        .product-meta {
            color: var(--muted);
            font-size: 0.8rem;
        }

        .material-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .material-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(37, 99, 235, 0.25);
            color: #1d4ed8;
            background: rgba(37, 99, 235, 0.08);
            font-size: 0.78rem;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .material-pill.video {
            border-color: rgba(8, 145, 178, 0.28);
            color: #0e7490;
            background: rgba(8, 145, 178, 0.12);
        }

        .material-pill:hover {
            transform: translateY(-1px);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px 60px;
            color: var(--muted);
            font-size: 0.95rem;
        }

        .empty-state strong {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 1.1rem;
        }

        .feedback {
            display: none;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid transparent;
            font-size: 0.88rem;
        }

        .feedback.show {
            display: block;
        }

        .feedback.error {
            background: rgba(220, 38, 38, 0.08);
            border-color: rgba(220, 38, 38, 0.18);
            color: #b91c1c;
        }

        .feedback.success {
            background: rgba(34, 197, 94, 0.08);
            border-color: rgba(34, 197, 94, 0.18);
            color: #15803d;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.28);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(4px);
            z-index: 20;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            width: min(760px, 100%);
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 30px 80px -40px rgba(15, 23, 42, 0.5);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 80px);
            overflow: hidden;
        }

        .modal header {
            padding: 24px 28px 12px;
            border-bottom: 1px solid rgba(15, 23, 42, 0.06);
        }

        .modal header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .modal header p {
            margin: 8px 0 0;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .modal main {
            padding: 20px 28px 28px;
            overflow-y: auto;
            display: grid;
            gap: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
        }

        .form-field {
            display: grid;
            gap: 8px;
        }

        .form-field label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            font: inherit;
            background: #fff;
        }

        .materials-panel {
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: 14px;
            padding: 18px 20px;
            display: grid;
            gap: 18px;
            background: rgba(248, 250, 252, 0.6);
        }

        .materials-panel h3 {
            margin: 0;
            font-size: 1rem;
        }

        .materials-panel > p {
            margin: 0;
            color: var(--muted);
            font-size: 0.85rem;
        }

        .material-row {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 12px;
            align-items: start;
            background: #fff;
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.06);
        }

        .material-row strong {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .material-row .material-meta {
            display: grid;
            gap: 6px;
        }

        .upload-btn {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px dashed rgba(37, 99, 235, 0.4);
            background: rgba(37, 99, 235, 0.06);
            color: #1d4ed8;
            font-size: 0.85rem;
            cursor: pointer;
            text-align: center;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .upload-btn:hover {
            background: rgba(37, 99, 235, 0.12);
            transform: translateY(-1px);
        }

        .upload-status {
            font-size: 0.78rem;
            color: var(--muted);
            line-height: 1.4;
        }

        .modal footer {
            padding: 18px 28px;
            border-top: 1px solid rgba(15, 23, 42, 0.08);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: rgba(248, 250, 252, 0.8);
        }

        .secondary-btn {
            padding: 10px 18px;
            border-radius: 10px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            background: #fff;
            font-weight: 500;
            cursor: pointer;
        }

        .secondary-btn:hover {
            background: rgba(15, 23, 42, 0.04);
        }

        .primary-solid {
            background: var(--primary);
            color: #fff;
            border: none;
        }

        .primary-solid:hover {
            background: #1d4ed8;
        }

        @media (max-width: 1100px) {
            .app-shell {
                grid-template-columns: 1fr;
            }

            aside {
                display: none;
            }

            main {
                padding: 24px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .material-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 640px) {
            .material-row {
                grid-template-columns: 1fr;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-bar input[type="date"],
            .filter-bar input[type="search"] {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="app-shell">
    <aside>
        <div class="workspace">
            <div class="workspace-icon">è·¨</div>
            <div class="workspace-info">
                <strong>è·¨å¢ƒé¡¹ç›®å·¥ä½œåŒº</strong>
                <span>Notion Â· äº‘ç«¯åä½œ</span>
            </div>
        </div>

        <div class="nav-group">
            <h3>å¿«é€Ÿå…¥å£</h3>
            <button class="nav-button active"><span class="nav-icon">ğŸ“</span>æ¯æ—¥ä»»åŠ¡è¿›åº¦åº“</button>
            <button class="nav-button"><span class="nav-icon">ğŸ—‚ï¸</span>ç´ æå½’æ¡£</button>
            <button class="nav-button"><span class="nav-icon">ğŸ“ˆ</span>æ•°æ®çœ‹æ¿</button>
            <button class="nav-button"><span class="nav-icon">ğŸ“</span>æ“ä½œæ‰‹å†Œ</button>
        </div>

        <div class="nav-group">
            <h3>æœ€è¿‘</h3>
            <button class="nav-button"><span class="nav-icon">â­</span>ç²¾é€‰æ´»åŠ¨ç´ æ</button>
            <button class="nav-button"><span class="nav-icon">ğŸ§­</span>ä»»åŠ¡æ’æœŸ</button>
        </div>
    </aside>

    <main>
        <div class="top-bar">
            <div class="breadcrumbs">
                <span>è·¨å¢ƒå›¢é˜Ÿ</span>
                <span>/</span>
                <strong>æ¯æ—¥ä»»åŠ¡è¿›åº¦åº“</strong>
            </div>
            <div class="toolbar">
                <button class="primary-btn" id="newTaskBtn">ï¼‹ æ–°å»ºä»»åŠ¡</button>
                <div class="user-avatar" aria-hidden="true"></div>
            </div>
        </div>

        <div class="page-header">
            <div class="page-title">
                <h1>è·¨å¢ƒç”µå•†ç´ æç®¡ç†åº“</h1>
                <p>é›†ä¸­ç®¡ç†æ¯æ—¥ä»»åŠ¡ä¸ç´ æï¼Œè¿½è¸ªä¸åŒå•†å“åœ¨å„å›½å®¶ç«™ç‚¹çš„å†…å®¹äº§å‡ºï¼Œç¡®ä¿æ¯ä¸ªå•†å“ä¸Šä¼ ä¸‰é¡¹ç´ æå¹¶è¦†ç›–ç…§ç‰‡/è§†é¢‘ç±»å‹ã€‚</p>
            </div>
            <div class="metric-card">
                <span>å·²ç™»è®°ä»»åŠ¡</span>
                <strong id="taskTotal">0</strong>
                <span style="color: var(--muted);">æœ€è¿‘æ›´æ–°ï¼š<span id="lastUpdated">â€”</span></span>
            </div>
        </div>

        <div class="filter-bar">
            <label for="filterDate">æŒ‰æ—¥æœŸç­›é€‰</label>
            <input type="date" id="filterDate">
            <input type="search" id="searchKeyword" placeholder="æœç´¢å•†å“åç§° / ç±»å‹ / å›½å®¶">
        </div>

        <div class="feedback" id="feedback"></div>

        <div class="data-card">
            <table>
                <thead>
                <tr>
                    <th style="width: 140px;">æ—¥æœŸ</th>
                    <th style="width: 240px;">å•†å“ä¿¡æ¯</th>
                    <th>ç´ æï¼ˆéœ€ 3 é¡¹ï¼‰</th>
                    <th style="width: 160px;">æ›´æ–°è¯´æ˜</th>
                </tr>
                </thead>
                <tbody id="taskTableBody">
                </tbody>
            </table>
        </div>
    </main>
</div>

<div class="modal-overlay" id="taskModalOverlay" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
    <div class="modal">
        <header>
            <h2 id="taskModalTitle">æ–°å»ºæ¯æ—¥ä»»åŠ¡</h2>
            <p>å¡«å†™ä»»åŠ¡ä¿¡æ¯å¹¶ä¸Šä¼  3 é¡¹ç´ æï¼Œç¡®ä¿åŒæ—¶åŒ…å«ç…§ç‰‡ä¸è§†é¢‘ç±»å‹ï¼Œå¯ä¸ºç´ æé™„åŠ å¤‡æ³¨ã€‚</p>
        </header>
        <main>
            <form id="taskForm">
                <div class="form-grid">
                    <div class="form-field">
                        <label for="taskDate">ä»»åŠ¡æ—¥æœŸ</label>
                        <input type="date" id="taskDate" required>
                    </div>
                    <div class="form-field">
                        <label for="productName">å•†å“åç§°</label>
                        <input type="text" id="productName" placeholder="è¯·è¾“å…¥å•†å“åç§°" required>
                    </div>
                    <div class="form-field">
                        <label for="productType">å•†å“ç±»å‹</label>
                        <input type="text" id="productType" placeholder="å¦‚ï¼šç¾å¦† / å®¶å±… / ç”µå­" required>
                    </div>
                    <div class="form-field">
                        <label for="productCountry">æŠ•æ”¾å›½å®¶</label>
                        <input type="text" id="productCountry" placeholder="å¦‚ï¼šç¾å›½ / æ—¥æœ¬" required>
                    </div>
                </div>

                <section class="materials-panel">
                    <div>
                        <h3>ç´ æè¦æ±‚</h3>
                        <p>è¯·ä¸Šä¼  3 é¡¹ç´ æï¼Œæ”¯æŒç…§ç‰‡ï¼ˆJPG/PNGï¼‰ä¸è§†é¢‘ï¼ˆMP4/MOVï¼‰ï¼Œä¼šè‡ªåŠ¨è®°å½•ä¸Šä¼ æ—¶é—´ï¼Œå¯å¡«å†™å¤‡æ³¨ä¿¡æ¯ã€‚</p>
                    </div>
                    <div class="material-row" data-material-index="0">
                        <strong>ç´ æ 1</strong>
                        <select class="material-type" required>
                            <option value="">é€‰æ‹©ç±»å‹</option>
                            <option value="photo">ç…§ç‰‡</option>
                            <option value="video">è§†é¢‘</option>
                        </select>
                        <div class="material-meta">
                            <button class="upload-btn" type="button">ä¸Šä¼ æ–‡ä»¶</button>
                            <div class="upload-status">å°šæœªä¸Šä¼ </div>
                            <input type="file" class="material-file" accept="image/*,video/*" hidden>
                        </div>
                        <input type="text" class="material-name" placeholder="æ–‡ä»¶å" readonly>
                        <input type="text" class="material-remark" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="material-row" data-material-index="1">
                        <strong>ç´ æ 2</strong>
                        <select class="material-type" required>
                            <option value="">é€‰æ‹©ç±»å‹</option>
                            <option value="photo">ç…§ç‰‡</option>
                            <option value="video">è§†é¢‘</option>
                        </select>
                        <div class="material-meta">
                            <button class="upload-btn" type="button">ä¸Šä¼ æ–‡ä»¶</button>
                            <div class="upload-status">å°šæœªä¸Šä¼ </div>
                            <input type="file" class="material-file" accept="image/*,video/*" hidden>
                        </div>
                        <input type="text" class="material-name" placeholder="æ–‡ä»¶å" readonly>
                        <input type="text" class="material-remark" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="material-row" data-material-index="2">
                        <strong>ç´ æ 3</strong>
                        <select class="material-type" required>
                            <option value="">é€‰æ‹©ç±»å‹</option>
                            <option value="photo">ç…§ç‰‡</option>
                            <option value="video">è§†é¢‘</option>
                        </select>
                        <div class="material-meta">
                            <button class="upload-btn" type="button">ä¸Šä¼ æ–‡ä»¶</button>
                            <div class="upload-status">å°šæœªä¸Šä¼ </div>
                            <input type="file" class="material-file" accept="image/*,video/*" hidden>
                        </div>
                        <input type="text" class="material-name" placeholder="æ–‡ä»¶å" readonly>
                        <input type="text" class="material-remark" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰">
                    </div>
                </section>
            </form>
        </main>
        <footer>
            <button class="secondary-btn" type="button" data-close-modal>å–æ¶ˆ</button>
            <button class="primary-solid secondary-btn" type="submit" form="taskForm">ä¿å­˜ä»»åŠ¡</button>
        </footer>
    </div>
</div>

<script>
    const storageKey = 'daily-task-progress';
    let tasks = [];

    const modalOverlay = document.getElementById('taskModalOverlay');
    const taskForm = document.getElementById('taskForm');
    const feedback = document.getElementById('feedback');
    const filterDate = document.getElementById('filterDate');
    const searchKeyword = document.getElementById('searchKeyword');
    const taskTableBody = document.getElementById('taskTableBody');
    const taskTotal = document.getElementById('taskTotal');
    const lastUpdated = document.getElementById('lastUpdated');

    function showFeedback(message, type = 'success') {
        feedback.textContent = message;
        feedback.className = `feedback show ${type}`;
        setTimeout(() => {
            feedback.className = 'feedback';
        }, 3200);
    }

    function openModal() {
        resetForm();
        modalOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        modalOverlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    function resetForm() {
        taskForm.reset();
        const rows = taskForm.querySelectorAll('.material-row');
        rows.forEach(row => {
            row.classList.remove('has-file');
            row.querySelector('.upload-status').textContent = 'å°šæœªä¸Šä¼ ';
            row.querySelector('.material-name').value = '';
            row.dataset.fileData = '';
            row.dataset.fileName = '';
            row.dataset.uploadedAt = '';
        });
    }

    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function handleMaterialUpload(row, file) {
        readFileAsDataURL(file).then(dataUrl => {
            const uploadedAt = new Date().toISOString();
            row.dataset.fileData = dataUrl;
            row.dataset.fileName = file.name;
            row.dataset.uploadedAt = uploadedAt;
            row.querySelector('.upload-status').textContent = `ä¸Šä¼ äº ${new Date(uploadedAt).toLocaleString()}`;
            row.querySelector('.material-name').value = file.name;
        }).catch(() => {
            showFeedback('ç´ æä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚', 'error');
        });
    }

    function collectMaterials() {
        const rows = [...taskForm.querySelectorAll('.material-row')];
        const materials = [];

        for (const row of rows) {
            const type = row.querySelector('.material-type').value;
            const remark = row.querySelector('.material-remark').value.trim();
            const data = row.dataset.fileData;
            const name = row.dataset.fileName;
            const uploadedAt = row.dataset.uploadedAt;

            if (!type) {
                throw new Error('è¯·ä¸ºæ¯é¡¹ç´ æé€‰æ‹©ç±»å‹ã€‚');
            }

            if (!data) {
                throw new Error('è¯·å®Œæˆ 3 é¡¹ç´ æçš„ä¸Šä¼ ã€‚');
            }

            materials.push({
                id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
                type,
                remark,
                data,
                name,
                uploadedAt
            });
        }

        const hasPhoto = materials.some(material => material.type === 'photo');
        const hasVideo = materials.some(material => material.type === 'video');

        if (!hasPhoto || !hasVideo) {
            throw new Error('ç´ æéœ€åŒæ—¶åŒ…å«ç…§ç‰‡ä¸è§†é¢‘ï¼Œè¯·è°ƒæ•´ç´ æç±»å‹ã€‚');
        }

        return materials;
    }

    function formatMaterialType(type) {
        return type === 'photo' ? 'ç…§ç‰‡' : 'è§†é¢‘';
    }

    function formatDate(date) {
        return new Date(date).toLocaleDateString('zh-CN');
    }

    function formatDateTime(dateTime) {
        return new Date(dateTime).toLocaleString('zh-CN');
    }

    function persistTasks() {
        localStorage.setItem(storageKey, JSON.stringify(tasks));
    }

    function loadTasks() {
        try {
            const stored = localStorage.getItem(storageKey);
            tasks = stored ? JSON.parse(stored) : [];
        } catch (error) {
            console.error('Failed to parse tasks from storage', error);
            tasks = [];
        }
    }

    function updateStats() {
        taskTotal.textContent = tasks.length;
        if (!tasks.length) {
            lastUpdated.textContent = 'â€”';
            return;
        }
        const latest = tasks.reduce((latestTask, current) => {
            if (!latestTask || current.createdAt > latestTask.createdAt) {
                return current;
            }
            return latestTask;
        }, null);
        lastUpdated.textContent = latest ? formatDateTime(latest.createdAt) : 'â€”';
    }

    function renderTasks() {
        const keyword = searchKeyword.value.trim().toLowerCase();
        const dateValue = filterDate.value;
        const filtered = tasks.filter(task => {
            const matchesDate = dateValue ? task.date === dateValue : true;
            const matchesKeyword = keyword
                ? [task.productName, task.productType, task.country]
                    .join(' ')
                    .toLowerCase()
                    .includes(keyword)
                : true;
            return matchesDate && matchesKeyword;
        });

        taskTableBody.innerHTML = '';

        if (!filtered.length) {
            const emptyRow = document.createElement('tr');
            const emptyCell = document.createElement('td');
            emptyCell.colSpan = 4;
            emptyCell.innerHTML = '<div class="empty-state"><strong>æš‚æ— ä»»åŠ¡è®°å½•</strong>è¯·ç‚¹å‡»å³ä¸Šè§’â€œæ–°å»ºä»»åŠ¡â€æ·»åŠ ä»Šæ—¥ä»»åŠ¡ï¼Œå¹¶ä¸Šä¼ å®Œæ•´ç´ æã€‚</div>';
            emptyRow.appendChild(emptyCell);
            taskTableBody.appendChild(emptyRow);
            updateStats();
            return;
        }

        filtered.forEach(task => {
            const row = document.createElement('tr');

            const dateCell = document.createElement('td');
            dateCell.textContent = formatDate(task.date);

            const productCell = document.createElement('td');
            productCell.className = 'product-cell';
            const title = document.createElement('div');
            title.className = 'product-title';
            title.textContent = task.productName;
            const meta = document.createElement('div');
            meta.className = 'product-meta';
            meta.textContent = `${task.productType} Â· ${task.country}`;
            productCell.append(title, meta);

            const materialsCell = document.createElement('td');
            const pillGroup = document.createElement('div');
            pillGroup.className = 'material-pills';

            task.materials.forEach((material, index) => {
                const pill = document.createElement('button');
                pill.type = 'button';
                pill.className = `material-pill ${material.type === 'video' ? 'video' : ''}`;
                pill.textContent = `${formatMaterialType(material.type)} Â· ${index + 1}`;
                pill.title = `ä¸Šä¼ æ—¶é—´ï¼š${formatDateTime(material.uploadedAt)}\nå¤‡æ³¨ï¼š${material.remark || 'æ— '}`;
                pill.dataset.taskId = task.id;
                pill.dataset.materialId = material.id;
                pillGroup.appendChild(pill);
            });

            materialsCell.appendChild(pillGroup);

            const remarkCell = document.createElement('td');
            remarkCell.textContent = task.materials
                .map(material => material.remark)
                .filter(Boolean)
                .join(' / ') || 'â€”';

            row.append(dateCell, productCell, materialsCell, remarkCell);
            taskTableBody.appendChild(row);
        });

        updateStats();
    }

    function downloadMaterial(taskId, materialId) {
        const task = tasks.find(item => item.id === taskId);
        if (!task) return;
        const material = task.materials.find(item => item.id === materialId);
        if (!material) return;
        const link = document.createElement('a');
        link.href = material.data;
        const extension = material.type === 'photo' ? (material.name.match(/\.(\w+)$/)?.[1] || 'jpg') : (material.name.match(/\.(\w+)$/)?.[1] || 'mp4');
        link.download = `${task.productName.replace(/\s+/g, '_')}_${materialId}.${extension}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function bindMaterialRow(row) {
        const uploadBtn = row.querySelector('.upload-btn');
        const fileInput = row.querySelector('.material-file');

        uploadBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', event => {
            const file = event.target.files?.[0];
            if (!file) return;
            handleMaterialUpload(row, file);
        });
    }

    document.getElementById('newTaskBtn').addEventListener('click', openModal);

    modalOverlay.addEventListener('click', event => {
        if (event.target === modalOverlay) {
            closeModal();
        }
    });

    document.querySelectorAll('[data-close-modal]').forEach(btn => {
        btn.addEventListener('click', closeModal);
    });

    taskForm.addEventListener('submit', event => {
        event.preventDefault();
        try {
            const materials = collectMaterials();
            const task = {
                id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
                date: document.getElementById('taskDate').value,
                productName: document.getElementById('productName').value.trim(),
                productType: document.getElementById('productType').value.trim(),
                country: document.getElementById('productCountry').value.trim(),
                materials,
                createdAt: new Date().toISOString()
            };

            if (!task.date || !task.productName || !task.productType || !task.country) {
                throw new Error('è¯·å®Œæ•´å¡«å†™ä»»åŠ¡ä¿¡æ¯ã€‚');
            }

            tasks.unshift(task);
            persistTasks();
            renderTasks();
            showFeedback('ä»»åŠ¡å·²ä¿å­˜ï¼Œç´ æåŒæ­¥å®Œæˆã€‚', 'success');
            closeModal();
        } catch (error) {
            showFeedback(error.message, 'error');
        }
    });

    taskTableBody.addEventListener('click', event => {
        const target = event.target;
        if (target.classList.contains('material-pill')) {
            downloadMaterial(target.dataset.taskId, target.dataset.materialId);
        }
    });

    filterDate.addEventListener('change', renderTasks);
    searchKeyword.addEventListener('input', renderTasks);

    document.addEventListener('keydown', event => {
        if (event.key === 'Escape' && modalOverlay.classList.contains('active')) {
            closeModal();
        }
    });

    document.querySelectorAll('.material-row').forEach(bindMaterialRow);

    loadTasks();
    renderTasks();
</script>
</body>
</html>
